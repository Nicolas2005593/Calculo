<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dominio, Rango y As√≠ntotas</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.5.0/math.min.js"></script>
  <style>
    body{margin:0;font-family:sans-serif;display:flex;height:100vh}
    .panel{flex:1;padding:20px}
    h1{font-size:1.2rem}
    input,button{width:100%;padding:8px;margin:10px 0;font-size:1rem}
    button{background:#1976D2;color:#fff;border:none;border-radius:4px;cursor:pointer}
    button:hover{background:#145ca3}
    #resultados{background:#fff;padding:10px;border:1px solid #ddd;border-radius:6px}
    canvas{width:100%;background:#fff;border:1px solid #ddd;border-radius:6px;margin-top:20px}
    .chat-container{flex:0 0 300px;border-left:2px solid #ddd;background:#fff;display:flex;flex-direction:column}
    .chat-header{background:#1976D2;color:#fff;text-align:center;padding:10px}
    .chat-body{flex:1;overflow:auto;padding:10px}
    .msg{margin-bottom:12px;line-height:1.4}
    .user span{background:#cce5ff;padding:8px 12px;border-radius:10px 10px 0 10px;display:inline-block;float:right}
    .bot span{background:#eee;padding:8px 12px;border-radius:10px 10px 10px 0;display:inline-block}
  </style>
</head>
<body>

<div class="panel">
  <h1>Escribe una funci√≥n: ej. (x+1)/(x-2), sqrt(x), x^2 + 3x</h1>
  <input id="funcion" placeholder="Escribe f(x)">
  <button onclick="resolver()">Calcular dominio, rango y as√≠ntotas</button>
  <div id="resultados"></div>
  <canvas id="grafico"></canvas>
</div>

<div class="chat-container">
  <div class="chat-header">ü§ñ Bot Matem√°tico</div>
  <div id="chat" class="chat-body"></div>
</div>

<script>
let chart;
const chat = document.getElementById('chat');

function addMsg(sender, text){
  const div = document.createElement('div');
  div.className = 'msg ' + sender;
  div.innerHTML = `<span>${text}</span>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}
function speak(text){
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'es-ES';
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}

function calcularDominio(f){
  let dominio = [];
  for(let x = -100; x <= 100; x += 0.5){
    try {
      const y = f.evaluate({x});
      if (typeof y === 'number' && isFinite(y)) dominio.push(x);
    } catch(e){}
  }
  return dominio;
}

function calcularRango(f, dominio){
  const valores = dominio.map(x => {
    try {
      return f.evaluate({x});
    } catch { return null; }
  }).filter(y => typeof y === 'number' && isFinite(y));
  const min = Math.min(...valores);
  const max = Math.max(...valores);
  return [min, max];
}

function encontrarAsintotas(f){
  const asintotas = [];
  for (let x = -20; x <= 20; x += 0.1){
    let y1, y2;
    try { y1 = f.evaluate({x: x - 0.01}); } catch {}
    try { y2 = f.evaluate({x: x + 0.01}); } catch {}
    if (y1 !== undefined && y2 !== undefined && Math.abs(y1 - y2) > 50){
      asintotas.push(Number(x.toFixed(2)));
    }
  }
  return [...new Set(asintotas)];
}

function encontrarAsintotaHorizontal(f){
  try {
    const yPlus = f.evaluate({x: 1e6});
    const yMinus = f.evaluate({x: -1e6});
    if (Math.abs(yPlus - yMinus) < 1){
      return yPlus.toFixed(2);
    }
  } catch {}
  return null;
}

function resolver(){
  const expresion = document.getElementById('funcion').value;
  addMsg('user', expresion);

  let f;
  try {
    f = math.compile(expresion);
  } catch (e){
    alert("Funci√≥n inv√°lida.");
    return;
  }

  // Dominio y rango
  const dominioArray = calcularDominio(f);
  const [minY, maxY] = calcularRango(f, dominioArray);
  const asintotasV = encontrarAsintotas(f);
  const asintotaH = encontrarAsintotaHorizontal(f);

  let texto = `<strong>Dominio:</strong> x ‚àà [${Math.min(...dominioArray).toFixed(2)}, ${Math.max(...dominioArray).toFixed(2)}]<br>`;
  texto += `<strong>Rango (aproximado):</strong> y ‚àà [${minY.toFixed(2)}, ${maxY.toFixed(2)}]<br>`;
  texto += `<strong>As√≠ntotas verticales:</strong> ${asintotasV.length ? asintotasV.join(', ') : 'ninguna'}<br>`;
  texto += `<strong>As√≠ntota horizontal:</strong> ${asintotaH !== null ? 'y = ' + asintotaH : 'ninguna'}`;
  document.getElementById('resultados').innerHTML = texto;

  const botMsg = `Dominio de x: desde ${Math.min(...dominioArray).toFixed(2)} hasta ${Math.max(...dominioArray).toFixed(2)}.
Rango de y: de ${minY.toFixed(2)} a ${maxY.toFixed(2)}.
As√≠ntotas verticales en: ${asintotasV.length ? asintotasV.join(', ') : 'ninguna'}.
As√≠ntota horizontal: ${asintotaH !== null ? 'y = ' + asintotaH : 'ninguna'}.`;

  addMsg('bot', botMsg);
  speak(botMsg);

  // Gr√°fica
  const xs = [], ys = [];
  for (let x = -20; x <= 20; x += 0.2){
    try {
      const y = f.evaluate({x});
      xs.push(x.toFixed(2));
      ys.push(y);
    } catch {
      xs.push(x.toFixed(2));
      ys.push(null);
    }
  }

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById('grafico'), {
    type: 'line',
    data: {
      labels: xs,
      datasets: [{
        label: `f(x) = ${expresion}`,
        data: ys,
        fill: false,
        borderWidth: 2,
        spanGaps: false
      }]
    },
    options: {
      scales: {
        x: { title: { display: true, text: 'x' }},
        y: { title: { display: true, text: 'f(x)' }}
      }
    }
  });
}
</script>
</body>
</html>
