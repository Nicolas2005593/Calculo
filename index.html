<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resuelve tu ecuaci√≥n con bot parlante</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.5.0/math.min.js"></script>
  <style>
    body {margin:0;font-family:sans-serif;display:flex;height:100vh}
    .panel {
      flex:1;
      padding:20px;
      background:#f5f5f5;
    }
    h1 {
      font-size:1.3rem;
      margin-bottom:10px;
    }
    input, button {
      width:100%;
      font-size:1rem;
      padding:8px;
      margin-bottom:12px;
    }
    button {
      background:#1976d2;
      color:#fff;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }
    button:hover {
      background:#145ca3;
    }
    #resultados {
      background:#fff;
      padding:12px;
      border-radius:6px;
      border:1px solid #ddd;
      margin-bottom:20px;
    }
    canvas {
      width:100%;
      height:300px;
      background:#fff;
      border:1px solid #ccc;
      border-radius:6px;
    }
    .chat-container {
      flex:0 0 300px;
      background:#fff;
      border-left:2px solid #ddd;
      display:flex;
      flex-direction:column;
    }
    .chat-header {
      background:#1976d2;
      color:#fff;
      text-align:center;
      padding:10px;
      font-weight:bold;
    }
    .chat-body {
      flex:1;
      overflow:auto;
      padding:10px;
    }
    .msg {
      margin-bottom:12px;
      line-height:1.4;
    }
    .user span {
      background:#cce5ff;
      padding:8px 12px;
      border-radius:10px 10px 0 10px;
      display:inline-block;
      float:right;
    }
    .bot span {
      background:#eee;
      padding:8px 12px;
      border-radius:10px 10px 10px 0;
      display:inline-block;
    }
  </style>
</head>
<body>

<div class="panel">
  <h1>‚úèÔ∏è Escribe tu funci√≥n f(x):</h1>
  <input id="funcion" placeholder="Ej. x^2 + 3x - 4 o 1/(x-2)">
  <button onclick="resolver()">Resolver y graficar</button>
  <div id="resultados"></div>
  <canvas id="grafico"></canvas>
</div>

<div class="chat-container">
  <div class="chat-header">ü§ñ Bot Matem√°tico</div>
  <div id="chat" class="chat-body"></div>
</div>

<script>
let chart;
const chat = document.getElementById('chat');

function addMsg(sender, text){
  const div = document.createElement('div');
  div.className = 'msg ' + sender;
  div.innerHTML = `<span>${text}</span>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function speak(text){
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'es-ES';
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}

function calcularDominio(f){
  let dominio = [];
  for(let x = -100; x <= 100; x += 0.5){
    try {
      const y = f.evaluate({x});
      if (typeof y === 'number' && isFinite(y)) dominio.push(x);
    } catch(e){}
  }
  return dominio;
}

function calcularRango(f, dominio){
  const valores = dominio.map(x => {
    try {
      return f.evaluate({x});
    } catch { return null; }
  }).filter(y => typeof y === 'number' && isFinite(y));
  const min = Math.min(...valores);
  const max = Math.max(...valores);
  return [min, max];
}

function encontrarAsintotas(f){
  const asintotas = [];
  for (let x = -20; x <= 20; x += 0.1){
    let y1, y2;
    try { y1 = f.evaluate({x: x - 0.01}); } catch {}
    try { y2 = f.evaluate({x: x + 0.01}); } catch {}
    if (y1 !== undefined && y2 !== undefined && Math.abs(y1 - y2) > 50){
      asintotas.push(Number(x.toFixed(2)));
    }
  }
  return [...new Set(asintotas)];
}

function encontrarAsintotaHorizontal(f){
  try {
    const yPlus = f.evaluate({x: 1e6});
    const yMinus = f.evaluate({x: -1e6});
    if (Math.abs(yPlus - yMinus) < 1){
      return yPlus.toFixed(2);
    }
  } catch {}
  return null;
}

function resolver(){
  const expresion = document.getElementById('funcion').value;
  addMsg('user', expresion);

  let f;
  try {
    f = math.compile(expresion);
  } catch (e){
    alert("Funci√≥n inv√°lida.");
    return;
  }

  const dominioArray = calcularDominio(f);
  const [minY, maxY] = calcularRango(f, dominioArray);
  const asintotasV = encontrarAsintotas(f);
  const asintotaH = encontrarAsintotaHorizontal(f);

  let texto = `<strong>üìå Dominio:</strong> x ‚àà [${Math.min(...dominioArray).toFixed(2)}, ${Math.max(...dominioArray).toFixed(2)}]<br>`;
  texto += `<strong>üìå Rango (aproximado):</strong> y ‚àà [${minY.toFixed(2)}, ${maxY.toFixed(2)}]<br>`;
  texto += `<strong>üìå As√≠ntotas verticales:</strong> ${asintotasV.length ? asintotasV.join(', ') : 'ninguna'}<br>`;
  texto += `<strong>üìå As√≠ntota horizontal:</strong> ${asintotaH !== null ? 'y = ' + asintotaH : 'ninguna'}`;
  document.getElementById('resultados').innerHTML = texto;

  const botText = `Dominio desde ${Math.min(...dominioArray).toFixed(2)} hasta ${Math.max(...dominioArray).toFixed(2)}.
Rango aproximado de ${minY.toFixed(2)} a ${maxY.toFixed(2)}.
As√≠ntotas verticales: ${asintotasV.length ? asintotasV.join(', ') : 'ninguna'}.
As√≠ntota horizontal: ${asintotaH !== null ? 'y = ' + asintotaH : 'ninguna'}.`;

  addMsg('bot', botText);
  speak(botText);

  // Gr√°fica
  const xs = [], ys = [];
  for (let x = -20; x <= 20; x += 0.2){
    try {
      const y = f.evaluate({x});
      xs.push(x.toFixed(2));
      ys.push(y);
    } catch {
      xs.push(x.toFixed(2));
      ys.push(null);
    }
  }

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById('grafico'), {
    type: 'line',
    data: {
      labels: xs,
      datasets: [{
        label: `f(x) = ${expresion}`,
        data: ys,
        fill: false,
        borderWidth: 2,
        spanGaps: false
      }]
    },
    options: {
      scales: {
        x: { title: { display: true, text: 'x' }},
        y: { title: { display: true, text: 'f(x)' }}
      }
    }
  });
}
</script>
</body>
</html>
